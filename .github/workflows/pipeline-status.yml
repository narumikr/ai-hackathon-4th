name: "Pipeline Status"

on:
  workflow_run:
    workflows: 
      - "Stage 1: Lint Check"
      - "Stage 2: Code Quality Check"
    types: [completed]
    branches: [main, develop]

jobs:
  pipeline-status:
    name: Pipeline Status Report
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Get workflow runs
        id: get-runs
        uses: actions/github-script@v8
        with:
          script: |
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head_sha: '${{ github.event.workflow_run.head_sha }}',
              per_page: 100
            });
            
            const pipelineRuns = runs.workflow_runs.filter(run => 
              ['Stage 1: Lint Check', 'Stage 2: Code Quality Check'].includes(run.name)
            );
            
            const status = {
              stage1: pipelineRuns.find(r => r.name === 'Stage 1: Lint Check'),
              stage2: pipelineRuns.find(r => r.name === 'Stage 2: Code Quality Check')
            };
            
            return status;

      - name: Generate pipeline report
        uses: actions/github-script@v8
        with:
          script: |
            const status = ${{ steps.get-runs.outputs.result }};
            
            let summary = "# ğŸ”„ PR Quality Pipeline Status\n\n";
            
            // Stage 1
            if (status.stage1) {
              const icon = status.stage1.conclusion === 'success' ? 'âœ…' : 
                          status.stage1.conclusion === 'failure' ? 'âŒ' : 
                          status.stage1.status === 'in_progress' ? 'ğŸ”„' : 'â³';
              summary += `## ${icon} Stage 1: Lint Check\n`;
              summary += `- Status: ${status.stage1.conclusion || status.stage1.status}\n`;
              summary += `- Command: \`just check-quality\`\n`;
              summary += `- [View Details](${status.stage1.html_url})\n\n`;
            }
            
            // Stage 2
            if (status.stage2) {
              const icon = status.stage2.conclusion === 'success' ? 'âœ…' : 
                          status.stage2.conclusion === 'failure' ? 'âŒ' : 
                          status.stage2.status === 'in_progress' ? 'ğŸ”„' : 'â³';
              summary += `## ${icon} Stage 2: Code Quality Check\n`;
              summary += `- Status: ${status.stage2.conclusion || status.stage2.status}\n`;
              summary += `- Commands: \`just test-all\`, \`just build-frontend\`\n`;
              summary += `- [View Details](${status.stage2.html_url})\n\n`;
            } else if (status.stage1?.conclusion === 'success') {
              summary += `## â³ Stage 2: Code Quality Check\n`;
              summary += `- Status: Waiting to start\n`;
              summary += `- Commands: \`just test-all\`, \`just build-frontend\`\n\n`;
            } else if (status.stage1?.conclusion === 'failure') {
              summary += `## â­ï¸ Stage 2: Code Quality Check\n`;
              summary += `- Status: Skipped (Stage 1 failed)\n\n`;
            }
            
            // Overall status
            if (status.stage2?.conclusion === 'success') {
              summary += `## ğŸ‰ Pipeline Result: SUCCESS\n`;
              summary += `All quality checks passed! PR is ready for review.\n`;
            } else if (status.stage1?.conclusion === 'failure') {
              summary += `## âŒ Pipeline Result: FAILED at Stage 1\n`;
              summary += `Please fix lint errors and push again.\n`;
              summary += `Local check: \`just check-quality\`\n`;
            } else if (status.stage2?.conclusion === 'failure') {
              summary += `## âŒ Pipeline Result: FAILED at Stage 2\n`;
              summary += `Please fix test failures or build errors and push again.\n`;
              summary += `Local check: \`just test-all && just build-frontend\`\n`;
            } else {
              summary += `## ğŸ”„ Pipeline Result: IN PROGRESS\n`;
              summary += `Pipeline is still running...\n`;
            }
            
            await core.summary.addRaw(summary).write();