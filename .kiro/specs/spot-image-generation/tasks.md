# 実装計画: スポット画像生成機能

## 概要

本実装計画は、旅行ガイドアプリケーションにGemini APIを使用した画像生成プロンプト構築と、Vertex AI Image Generation APIを使用したスポット画像自動生成機能を追加します。画像生成は2段階のプロセス（プロンプト生成→画像生成）で実行され、旅行ガイド生成とは独立して非同期で処理されます。

## タスク

- [x] 1. ImageGenerationClientの実装
  - Vertex AI Image Generation API専用のクライアントを実装
  - google.genai.Clientを使用してVertexAI接続を初期化
  - generate_image()メソッドを実装（プロンプト、アスペクト比、タイムアウト、リトライ機能を含む）
  - 指数バックオフリトライロジックを実装
  - _要件: 2.1, 2.2, 2.3, 2.4, 7.3, 7.4_

- [ ]* 1.1 ImageGenerationClientのユニットテストを作成
  - 初期化とパラメータ設定のテスト
  - API呼び出し成功時のテスト
  - API呼び出し失敗時のエラーハンドリングテスト
  - リトライロジックのテスト
  - _要件: 2.1, 2.2, 2.3, 7.3, 7.4_

- [ ]* 1.2 ImageGenerationClientのプロパティテストを作成
  - **プロパティ2: 画像生成APIの呼び出し**
  - **検証要件: 要件2.1, 2.2, 2.3**
  - _要件: 2.1, 2.2, 2.3_

- [x] 2. IAIServiceインターフェースの拡張
  - generate_image_prompt()メソッドをIAIServiceに追加
  - generate_image()メソッドをIAIServiceに追加
  - 適切な型ヒントとドキュメンテーションを含める
  - _要件: 1.1, 1.2, 1.3, 2.1, 2.2_

- [x] 3. GeminiAIServiceアダプタの拡張
  - [x] 3.1 generate_image_prompt()メソッドを実装
    - スポット情報からプロンプトテンプレートを構築
    - Gemini APIを呼び出してプロンプトを生成
    - 日本語とリアルな写真スタイルを指定
    - _要件: 1.1, 1.2, 1.3, 1.4, 1.5_

  - [x] 3.2 generate_image()メソッドを実装
    - ImageGenerationClientを使用して画像を生成
    - エラーハンドリングとリトライロジックを実装
    - _要件: 2.1, 2.2, 2.3, 2.4, 2.5_

  - [x] 3.3 コンストラクタにImageGenerationClientを追加
    - 既存のGeminiClientと新しいImageGenerationClientの両方を受け取る
    - _要件: 2.1_

- [ ]* 3.4 GeminiAIServiceのユニットテストを作成
  - プロンプト生成のテスト
  - 画像生成のテスト
  - エラーハンドリングのテスト
  - _要件: 1.1, 1.2, 1.3, 2.1, 2.2, 2.3_

- [ ]* 3.5 GeminiAIServiceのプロパティテストを作成
  - **プロパティ1: プロンプト生成の完全性**
  - **検証要件: 要件1.1, 1.2, 1.3**
  - _要件: 1.1, 1.2, 1.3_

- [x] 4. SpotDetail値オブジェクトの拡張
  - image_urlフィールドを追加（str | None）
  - image_statusフィールドを追加（デフォルト: "not_started"）
  - バリデーションロジックを追加（有効なステータス値のチェック）
  - update_spot_image()ヘルパー関数を実装（immutableなので新しいインスタンスを生成）
  - _要件: 5.1, 5.2, 5.3, 5.4_

- [ ]* 4.1 SpotDetailのユニットテストを作成
  - 画像フィールドのバリデーションテスト
  - update_spot_image()のテスト
  - _要件: 5.1, 5.2, 5.3, 5.4_

- [x] 5. Cloud Storageパス生成とアップロード機能の実装
  - [x] 5.1 画像保存パス生成関数を実装
    - urllib.parse.quoteを使用してスポット名をURLセーフに変換
    - パス形式: travel-guides/{plan_id}/spots/{spot_name_safe}.jpg
    - _要件: 3.3_

  - [x] 5.2 画像アップロード関数を実装
    - 既存のCloudStorageService.upload_file()を使用
    - 署名付きURLを取得して返す
    - content_typeを"image/jpeg"に設定
    - _要件: 3.1, 3.2, 3.4, 3.5_

- [ ]* 5.3 Cloud Storageパス生成のユニットテストを作成
  - パス形式のテスト
  - URLエンコーディングのテスト
  - _要件: 3.3_

- [ ]* 5.4 Cloud Storageパス生成のプロパティテストを作成
  - **プロパティ3: Cloud Storageパス構造**
  - **検証要件: 要件3.1, 3.2, 3.3, 3.4**
  - _要件: 3.1, 3.2, 3.3, 3.4_

- [x] 6. チェックポイント - 基本コンポーネントのテスト
  - すべてのテストが通ることを確認
  - 質問があればユーザーに確認

- [x] 7. GenerateSpotImagesUseCaseの実装
  - [x] 7.1 ユースケースクラスの基本構造を実装
    - コンストラクタ（IAIService, IStorageService, ITravelGuideRepository, max_concurrent）
    - execute()メソッドのシグネチャ
    - _要件: 4.1, 6.1_

  - [x] 7.2 単一スポット画像生成メソッドを実装
    - _generate_single_spot_image()を実装
    - プロンプト生成→画像生成→アップロードの流れ
    - エラーハンドリングとログ出力
    - _要件: 1.1, 2.1, 3.1, 7.1, 7.2, 7.5_

  - [x] 7.3 並列処理メソッドを実装
    - _generate_images_parallel()を実装
    - asyncio.Semaphoreで並行実行数を制限
    - asyncio.gatherで並列実行
    - 一部失敗しても成功した結果を返す
    - _要件: 6.1, 6.2, 6.3, 6.4, 6.5_

  - [x] 7.4 スポット画像ステータス更新メソッドを実装
    - _update_spot_image_status()を実装
    - TravelGuideを取得→SpotDetailを更新→保存
    - 新しいDBセッションを使用
    - _要件: 4.2, 5.2, 5.3, 5.4_

  - [x] 7.5 execute()メソッドを実装
    - 並列処理を開始
    - 各スポットの結果を個別にDB更新
    - _要件: 4.1, 4.2, 4.3, 4.4_

- [ ]* 7.6 GenerateSpotImagesUseCaseのユニットテストを作成
  - 単一スポット画像生成のテスト
  - 並列処理のテスト
  - ステータス更新のテスト
  - エラーハンドリングのテスト
  - _要件: 4.1, 4.2, 6.1, 6.3, 6.4, 7.1, 7.2, 7.5_

- [ ]* 7.7 GenerateSpotImagesUseCaseのプロパティテストを作成
  - **プロパティ5: ステータス遷移の正確性**
  - **検証要件: 要件5.1, 5.2, 5.3, 5.4**
  - **プロパティ6: 並列処理の完全性**
  - **検証要件: 要件6.1, 6.3, 6.4, 6.5**
  - **プロパティ7: エラーログの完全性**
  - **検証要件: 要件7.1, 7.2, 7.5**
  - **プロパティ8: リトライロジックの正確性**
  - **検証要件: 要件7.3, 7.4**
  - _要件: 5.1, 5.2, 5.3, 5.4, 6.1, 6.3, 6.4, 6.5, 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 8. TravelGuideRepositoryの拡張
  - _to_entity()メソッドで画像フィールドをデフォルト値で処理
  - _spot_details_to_dict()メソッドで画像フィールドを含める
  - 既存データとの互換性を確保
  - _要件: 8.5_

- [ ]* 8.1 TravelGuideRepositoryのユニットテストを作成
  - 画像フィールドを含むエンティティ変換のテスト
  - 既存データ（画像フィールドなし）の変換テスト
  - _要件: 8.5_

- [ ]* 8.2 TravelGuideRepositoryのプロパティテストを作成
  - **プロパティ10: 後方互換性**
  - **検証要件: 要件8.5**
  - _要件: 8.5_

- [x] 9. GenerateTravelGuideUseCaseへの統合
  - GenerateSpotImagesUseCaseをコンストラクタで受け取る
  - ガイド保存後に画像生成を非同期で開始（FastAPIのBackgroundTasksを使用）
  - ガイド生成の完了を画像生成の完了を待たずに返す
  - _要件: 4.1, 4.5_

- [ ]* 9.1 GenerateTravelGuideUseCaseの統合テストを作成
  - 画像生成が非同期で開始されることを確認
  - ガイド生成が画像生成を待たないことを確認
  - _要件: 4.1, 4.5_

- [ ]* 9.2 GenerateTravelGuideUseCaseのプロパティテストを作成
  - **プロパティ4: 非同期画像生成**
  - **検証要件: 要件4.1, 4.5**
  - _要件: 4.1, 4.5_

- [x] 10. APIレスポンススキーマの拡張
  - SpotDetailSchemaにimageUrlとimageStatusフィールドを追加
  - TravelGuideResponseに画像フィールドを含める
  - 既存のTravelGuideResponseSchema（AI出力検証用）は変更しない
  - _要件: 8.1, 8.2, 8.3, 8.4_

- [ ]* 10.1 APIレスポンススキーマのユニットテストを作成
  - 画像フィールドを含むレスポンスのシリアライゼーションテスト
  - _要件: 8.1, 8.2, 8.3, 8.4_

- [ ]* 10.2 APIレスポンススキーマのプロパティテストを作成
  - **プロパティ9: APIレスポンスの完全性**
  - **検証要件: 要件8.1, 8.2, 8.3, 8.4**
  - _要件: 8.1, 8.2, 8.3, 8.4_

- [x] 11. 設定管理の追加
  - backend/app/config/settings.pyに画像生成設定を追加
  - image_generation_model, image_generation_location, image_generation_max_concurrent等
  - 適切なデフォルト値を設定
  - _要件: 9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 12. 依存性注入の設定
  - ImageGenerationClientのインスタンス化
  - GeminiAIServiceへのImageGenerationClientの注入
  - GenerateSpotImagesUseCaseのインスタンス化
  - FastAPI依存性注入の設定
  - _要件: 2.1, 4.1_

- [x] 13. チェックポイント - バックエンド統合テスト
  - すべてのバックエンドテストが通ることを確認
  - 質問があればユーザーに確認

- [x] 14. フロントエンド: スポットカードコンポーネントの拡張
  - [x] 14.1 SpotCardコンポーネントに画像表示機能を追加
    - imageUrlが存在する場合は画像を表示
    - imageUrlがnullの場合はプレースホルダー画像を表示
    - 画像をカードの左側に配置
    - アスペクト比を維持しながら適切なサイズで表示
    - _要件: 10.1, 10.2, 10.4_

  - [x] 14.2 画像のalt属性を設定
    - スポット名を使用してアクセシビリティを確保
    - _要件: 10.5_

  - [x] 14.3 画像のスタイリング
    - レスポンシブデザインに対応
    - ローディング状態の表示（オプション）
    - _要件: 10.1, 10.4_

- [ ]* 14.4 SpotCardコンポーネントのユニットテストを作成
  - 画像表示のテスト
  - プレースホルダー表示のテスト
  - alt属性のテスト
  - _要件: 10.1, 10.2, 10.5_

- [ ]* 14.5 SpotCardコンポーネントのプロパティテストを作成
  - **プロパティ11: フロントエンド画像表示**
  - **検証要件: 要件10.1, 10.2, 10.4, 10.5**
  - _要件: 10.1, 10.2, 10.4, 10.5_

- [x] 15. TypeScript型定義の更新
  - SpotDetail型にimageUrlとimageStatusフィールドを追加
  - APIレスポンス型を更新
  - _要件: 8.1_

- [x] 16. 最終チェックポイント - E2Eテスト
  - すべてのテストが通ることを確認
  - 旅行ガイド生成→画像生成→フロントエンド表示の一連の流れを確認
  - 質問があればユーザーに確認

## 注意事項

- `*`マークのタスクはオプションで、MVPを早く完成させるためにスキップ可能です
- 各タスクは特定の要件を参照しており、トレーサビリティを確保しています
- チェックポイントで段階的な検証を行い、問題を早期に発見します
- プロパティベーステストは普遍的な正確性プロパティを検証します
- ユニットテストは特定の例、エッジケース、エラー条件を検証します
