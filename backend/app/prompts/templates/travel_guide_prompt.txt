<task>
以下の旅行計画と抽出された事実情報（出典付き）から、構造化された旅行ガイドを生成してください。
</task>

<travel_plan>
<destination>{destination}</destination>
<user_specified_spots>
{spots_text}
</user_specified_spots>
</travel_plan>

<extracted_facts_with_sources>
{extracted_facts}
</extracted_facts_with_sources>

<constraints>
- 上記の事実情報に含まれない内容は生成しない（推測・補完禁止）。
- スポット名はユーザー指定スポット + 「追加のおすすめスポット」欄に登場したもののみ許容する。
- 各スポットの説明には、可能な限り出典をMarkdownリンク形式で明示すること（例: [伊勢神宮公式サイト](https://example.com)）。
- 出典リンクを記載する場合は、https:// から始まる完全なURLを使用すること。
- 出典リンクのURLは、`<extracted_facts_with_sources>` に存在するURLを優先して使用すること。
- URLの改変・短縮・推測生成は禁止する（末尾スラッシュやパスを勝手に変更しない）。
- historicalBackground と historicalSignificance は、原則として末尾に1件以上の出典リンクを記載すること。
- 出典リンクが付けられない事実は、原則として本文に採用しないこと。
</constraints>

<output_structure_requirements>
1. overview（旅行全体の概要）の構成
   - 以下の4つの要素を含む、充実した概要文を作成する（200-400文字程度）

   a) 旅行の全体的なテーマや目的
      - この旅行がどのような歴史的テーマを持つか
      - どのような体験や学びが得られるか
      - 例: 「江戸時代の文化を体感する旅」「戦国時代の舞台を巡る歴史探訪」

   b) 訪問スポットの概要と関連性
      - 各スポットがどのように歴史的に関連しているか
      - なぜこの組み合わせが意味を持つのか
      - スポット間の時代的・地理的なつながり

   c) 歴史的な時代背景の要約
      - この旅行で体験できる主な歴史的時代や出来事
      - その時代の特徴や重要性を簡潔に説明

   d) おすすめポイントやハイライト
      - 特に注目すべき歴史的見どころ
      - この旅行ならではの学びのポイント
      - 旅行者が得られる価値や体験

2. spotDetails/checkpoints の構成
   - ユーザー指定の観光スポットを「必ず全て」含める
   - 歴史情報で推奨された追加スポットがあれば追加する
   - 各スポットには歴史的背景を含む説明を付ける
   - 🔴 重要: 各スポットの説明には、出典リンクを高頻度で含める
     * 出典形式は Markdownリンクの `[出典名](https://...)` に統一する
     * historicalBackground と historicalSignificance には原則として必ず出典リンクを含める
     * highlights に出典を含める場合は、本文の可読性を優先して簡潔にする

3. timeline（年表）の構成
   - 各観光スポットに関連する歴史的出来事を時系列で配置する
   - 旅行先全体の主要な歴史的出来事も含める
   - 各出来事の relatedSpots には関連するスポット名を正確に記載する

4. スポット名の一貫性（重要）
   - spotName と relatedSpots で使用するスポット名は完全に一致させる
   - 表記ゆれ（例: 「東京タワー」と「東京tower」）は絶対に避ける
   - 別名や通称は使用せず、一つの正式名称に統一する
   - 旅行先全体に関連する出来事の場合、relatedSpots に「{destination}」を使用する

5. 出力の簡潔性（重要）
   - historicalBackground は180〜320文字、historicalSignificance は160〜280文字を目安に記述する
   - historicalContext / significance は120〜220文字以内に収める
   - highlights / checkpoints は1項目あたり40文字以内にする
   - 指定文字数を超えないよう、必ず情報を要約して短くする
</output_structure_requirements>

<step_by_step_process>
ステップ1: 抽出された事実情報を分析し、全体像を把握
- 事実情報から主要な時代、テーマ、関連性を特定する
- スポット間のつながりや共通する歴史的背景を理解する
- 出典情報（URL付き）を確認し、信頼性の高い事実を優先する

ステップ2: overview（旅行全体の概要）を作成
- 旅行の全体的なテーマや目的を明確化する
- 訪問スポット間の歴史的関連性とつながりを説明する
- 時代背景の要約と、特に注目すべきハイライトを含める
- 🔴 重要: 「歴史の有名な話題との対比」を必ず含める
  * 例: 「同時期の日本では〜」「世界では〜」「一方ヨーロッパでは〜」
  * 訪問地の歴史を、より広い歴史的文脈の中で位置づける
- 200-400文字程度の充実した概要文にまとめる

ステップ3: 事実情報からスポットリストを作成
- ユーザー指定スポット + 推奨された追加スポット
- 各スポットの正式名称を決定し、リスト化する

ステップ4: 各スポットの詳細情報を作成
- 抽出された事実情報を基に、歴史的背景、見どころ、訪問のポイントを含める
- spotName はステップ3で決定した正式名称を使用する
- 🔴 重要: 各スポットに、出典リンクを高頻度で含める
  * historicalBackground と historicalSignificance には原則として1件以上の出典リンクを記載
  * highlights は必要に応じて出典リンクを付ける
  * 出典の形式: Markdownリンク `[出典名](https://...)`

ステップ5: 年表（timeline）を作成
- 抽出された事実情報から出来事を時系列に整理する
- 各出来事の relatedSpots にはステップ3のスポット名を「正確に」使用する
- スポット名の表記を再確認する

ステップ6: 最終確認
- overview が4つの要素（テーマ、関連性、時代背景、ハイライト）を含んでいるか確認
- 🔴 overview に「歴史の有名な話題との対比」が含まれているか確認
- historicalBackground / historicalSignificance の出典リンク密度が十分か確認
- 出典リンクが記載されている場合、Markdown形式かつ妥当なURLになっているか確認
- 全てのユーザー指定スポットが含まれているか確認
- spotName と relatedSpots の表記が完全に一致しているか確認
- スキーマ要件を満たしているか確認
</step_by_step_process>

<critical_rules>
🔴 必須ルール:
- ユーザー指定スポットの欠落は許されない
- 出典リンクは高頻度で記載し、記載する場合はMarkdown形式（`[出典名](https://...)`）を使用する
- 出典リンクを記載する場合、抽出済み事実のURLをそのまま転記する（1文字でも変更しない）
- 🔴 overview に「歴史の有名な話題との対比」を必ず含める
- スポット名の表記ゆれは絶対に避ける（データ整合性の観点から重要）
- 出力スキーマとの完全な一致が必要
- 🔴 全てのテキストは完全に日本語のみで記述する（英語、ロシア語、中国語などの混入は絶対禁止）

⚠️ 品質基準:
- 歴史的な正確性を保つ
- 旅行者にとって有用な情報を優先する
- 説明文は分かりやすい日本語で記述する
- 他言語の単語やフレーズが混ざらないように注意する
</critical_rules>
