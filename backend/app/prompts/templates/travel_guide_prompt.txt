<task>
以下の旅行計画と歴史情報から、構造化された旅行ガイドを生成してください。
</task>

<travel_plan>
<destination>{destination}</destination>
<user_specified_spots>
{spots_text}
</user_specified_spots>
</travel_plan>

<historical_context>
{historical_info}
</historical_context>

<output_structure_requirements>
1. overview（旅行全体の概要）の構成
   - 以下の4つの要素を含む、充実した概要文を作成する（200-400文字程度）

   a) 旅行の全体的なテーマや目的
      - この旅行がどのような歴史的テーマを持つか
      - どのような体験や学びが得られるか
      - 例: 「江戸時代の文化を体感する旅」「戦国時代の舞台を巡る歴史探訪」

   b) 訪問スポットの概要と関連性
      - 各スポットがどのように歴史的に関連しているか
      - なぜこの組み合わせが意味を持つのか
      - スポット間の時代的・地理的なつながり

   c) 歴史的な時代背景の要約
      - この旅行で体験できる主な歴史的時代や出来事
      - その時代の特徴や重要性を簡潔に説明

   d) おすすめポイントやハイライト
      - 特に注目すべき歴史的見どころ
      - この旅行ならではの学びのポイント
      - 旅行者が得られる価値や体験

2. spotDetails/checkpoints の構成
   - ユーザー指定の観光スポットを「必ず全て」含める
   - 歴史情報で推奨された追加スポットがあれば追加する
   - 各スポットには歴史的背景を含む説明を付ける

3. timeline（年表）の構成
   - 各観光スポットに関連する歴史的出来事を時系列で配置する
   - 旅行先全体の主要な歴史的出来事も含める
   - 各出来事の relatedSpots には関連するスポット名を正確に記載する

4. スポット名の一貫性（重要）
   - spotName と relatedSpots で使用するスポット名は完全に一致させる
   - 表記ゆれ（例: 「東京タワー」と「東京tower」）は絶対に避ける
   - 別名や通称は使用せず、一つの正式名称に統一する
   - 旅行先全体に関連する出来事の場合、relatedSpots に「{destination}」を使用する
</output_structure_requirements>

<step_by_step_process>
ステップ1: 歴史情報を分析し、全体像を把握
- 歴史情報から主要な時代、テーマ、関連性を特定する
- スポット間のつながりや共通する歴史的背景を理解する

ステップ2: overview（旅行全体の概要）を作成
- 旅行の全体的なテーマや目的を明確化する
- 訪問スポット間の歴史的関連性とつながりを説明する
- 時代背景の要約と、特に注目すべきハイライトを含める
- 200-400文字程度の充実した概要文にまとめる

ステップ3: 歴史情報からスポットリストを作成
- ユーザー指定スポット + 推奨された追加スポット
- 各スポットの正式名称を決定し、リスト化する

ステップ4: 各スポットの詳細情報を作成
- 歴史的背景、見どころ、訪問のポイントを含める
- spotName はステップ3で決定した正式名称を使用する

ステップ5: 年表（timeline）を作成
- 歴史情報から出来事を時系列に整理する
- 各出来事の relatedSpots にはステップ3のスポット名を「正確に」使用する
- スポット名の表記を再確認する

ステップ6: 最終確認
- overview が4つの要素（テーマ、関連性、時代背景、ハイライト）を含んでいるか確認
- 全てのユーザー指定スポットが含まれているか確認
- spotName と relatedSpots の表記が完全に一致しているか確認
- スキーマ要件を満たしているか確認
</step_by_step_process>

<critical_rules>
🔴 必須ルール:
- ユーザー指定スポットの欠落は許されない
- スポット名の表記ゆれは絶対に避ける（データ整合性の観点から重要）
- 出力スキーマとの完全な一致が必要
- 🔴 全てのテキストは完全に日本語のみで記述する（英語、ロシア語、中国語などの混入は絶対禁止）

⚠️ 品質基準:
- 歴史的な正確性を保つ
- 旅行者にとって有用な情報を優先する
- 説明文は分かりやすい日本語で記述する
- 他言語の単語やフレーズが混ざらないように注意する
</critical_rules>
