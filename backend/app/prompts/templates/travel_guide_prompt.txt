<task>
以下の旅行計画と抽出された事実情報（出典付き）から、構造化された旅行ガイドを生成してください。
</task>

<travel_plan>
<title>{title}</title>
<destination>{destination}</destination>
<user_specified_spots>
{spots_text}
</user_specified_spots>
</travel_plan>

<extracted_facts_with_sources>
{extracted_facts}
</extracted_facts_with_sources>

<constraints>
- 上記の事実情報に含まれない内容は生成しない（推測・補完禁止）。
- スポット名はユーザー指定スポット + 「追加のおすすめスポット」欄に登場したもののみ許容する。
- 出典情報そのものは出力しないが、事実の内容は抽出結果に忠実であること。
</constraints>

<output_structure_requirements>
1. overview（旅行全体の概要）の構成
   - 以下の4つの要素を含む、充実した概要文を作成する（200-400文字程度）

   a) 旅行の全体的なテーマや目的
      - ユーザーが付けた旅行タイトル（<title>）を冒頭で言及し、テーマの意図を反映する
      - タイトルのテーマ（グルメ、絶景、歴史人物など）を概要文の軸にする
      - 歴史的なテーマとタイトルテーマの両方を織り交ぜた概要にする
      - この旅行がどのような歴史的テーマを持つか
      - どのような体験や学びが得られるか
      - 例: 「江戸時代の文化を体感する旅」「戦国時代の舞台を巡る歴史探訪」

   b) 訪問スポットの概要と関連性
      - 各スポットがどのように歴史的に関連しているか
      - 各スポットが旅行タイトル（<title>）から読み取った追加のテーマとの関連
      - なぜこの組み合わせが意味を持つのか
      - スポット間の時代的・地理的なつながり

   c) 歴史的な時代背景の要約
      - この旅行で体験できる主な歴史的時代や出来事
      - その時代の特徴や重要性を簡潔に説明

   d) おすすめポイントやハイライト
      - 特に注目すべき歴史的見どころ
      - この旅行ならではの学びのポイント
      - 旅行者が得られる価値や体験

2. spotDetails/checkpoints の構成
   - ユーザー指定の観光スポットを「必ず全て」含める
   - 歴史情報で推奨された追加スポットがあれば追加する
   - 各スポットには歴史的背景を含む説明を付ける
   - 各スポットには旅行タイトル（<title>）から抽出したテーマに関連する情報を優先的に含める
     * グルメ系テーマ: そのスポット周辺の歴史ある名物・郷土料理・食文化を記載
     * 景観系テーマ: 景勝地としての歴史的評価・絶景ポイントを記載
     * 人物系テーマ: 関連する歴史的人物のエピソード・ゆかりを記載
     * テーマに関連する情報が事実情報に含まれていない場合、無理に追加しない
   - 🔴 重要: 各スポットの説明には「必ず出典を最低1件」含める
     * 出典の例: URL、『書籍名』、「資料館の展示」、公式サイト、文化庁の資料など
     * historicalBackground、historicalSignificance、highlightsのいずれかに出典を含める

3. timeline（年表）の構成
   - 各観光スポットに関連する歴史的出来事を時系列で配置する
   - 旅行先全体の主要な歴史的出来事も含める
   - 各出来事の relatedSpots には関連するスポット名を正確に記載する

4. スポット名の一貫性（重要）
   - spotName と relatedSpots で使用するスポット名は完全に一致させる
   - 表記ゆれ（例: 「東京タワー」と「東京tower」）は絶対に避ける
   - 別名や通称は使用せず、一つの正式名称に統一する
   - 旅行先全体に関連する出来事の場合、relatedSpots に「{destination}」を使用する

5. 出力の簡潔性（重要）
   - historicalBackground / historicalSignificance / historicalContext / significance はそれぞれ120〜200文字以内に収める
   - highlights / checkpoints は1項目あたり30文字以内にする
   - 指定文字数を超えないよう、必ず情報を要約して短くする
</output_structure_requirements>

<step_by_step_process>
ステップ0: 旅行タイトル（<title>）からテーマと意図を抽出
- タイトルに含まれるキーワードからユーザーの興味・関心を特定する
- テーマの例:
  * 「グルメツアー」→ 各スポット周辺の名物料理・食文化・歴史的な食の背景を重視
  * 「絶景めぐり」→ 景観・自然美・歴史的な景勝地としての価値を重視
  * 「戦国武将ゆかりの地」→ 武将との関連・合戦の歴史・城郭建築を重視
  * 「寺社仏閣巡り」→ 宗教的背景・建築様式・信仰の歴史を重視
- 抽出したテーマを以降の全ステップで一貫して反映する

ステップ1: 抽出された事実情報を分析し、全体像を把握
- 事実情報から主要な時代、テーマ、関連性を特定する
- ステップ0で特定したテーマに関連する事実を優先的に抽出する
- スポット間のつながりや共通する歴史的背景を理解する
- 出典情報を確認し、信頼性の高い事実を優先する

ステップ2: overview（旅行全体の概要）を作成
- ユーザーが付けた旅行タイトル（<title>）のテーマや意図を反映する
- 旅行の全体的なテーマや目的を明確化する
- 訪問スポット間の歴史的関連性とつながりを説明する
- 時代背景の要約と、特に注目すべきハイライトを含める
- 🔴 重要: 「歴史の有名な話題との対比」を必ず含める
  * 例: 「同時期の日本では〜」「世界では〜」「一方ヨーロッパでは〜」
  * 訪問地の歴史を、より広い歴史的文脈の中で位置づける
- 200-400文字程度の充実した概要文にまとめる

ステップ3: 事実情報からスポットリストを作成
- ユーザー指定スポット + 推奨された追加スポット
- 各スポットの正式名称を決定し、リスト化する

ステップ4: 各スポットの詳細情報を作成
- 抽出された事実情報を基に、歴史的背景、見どころ、訪問のポイントを含める
- spotName はステップ3で決定した正式名称を使用する
- 🔴 重要: 各スポットに「出典を最低1件」含める
  * historicalBackground、historicalSignificance、highlightsのいずれかに記載
  * 出典の形式: URL、『書籍名』、「施設名の展示」、公式サイト、文化庁資料など

ステップ5: 年表（timeline）を作成
- 抽出された事実情報から出来事を時系列に整理する
- 各出来事の relatedSpots にはステップ3のスポット名を「正確に」使用する
- スポット名の表記を再確認する

ステップ6: 最終確認
- overview が4つの要素（テーマ、関連性、時代背景、ハイライト）を含んでいるか確認
- 🔴 overview に「歴史の有名な話題との対比」が含まれているか確認
- 🔴 全てのスポットに「出典が最低1件」含まれているか確認
- 全てのユーザー指定スポットが含まれているか確認
- spotName と relatedSpots の表記が完全に一致しているか確認
- スキーマ要件を満たしているか確認
</step_by_step_process>

<critical_rules>
🔴 必須ルール:
- ユーザー指定スポットの欠落は許されない
- 🔴 各スポットに出典を最低1件含める（URL、書籍、施設の展示、公式資料など）
- 🔴 overview に「歴史の有名な話題との対比」を必ず含める
- スポット名の表記ゆれは絶対に避ける（データ整合性の観点から重要）
- 出力スキーマとの完全な一致が必要
- 🔴 全てのテキストは完全に日本語のみで記述する（英語、ロシア語、中国語などの混入は絶対禁止）

⚠️ 品質基準:
- 歴史的な正確性を保つ
- 旅行者にとって有用な情報を優先する
- 説明文は分かりやすい日本語で記述する
- 他言語の単語やフレーズが混ざらないように注意する
</critical_rules>
